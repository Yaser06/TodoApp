<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Board - AI Project</title>

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        /* Animations */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 0 30px rgba(102, 126, 234, 0.8); }
        }

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .shimmer {
            animation: shimmer 2s infinite;
            background: linear-gradient(90deg,
                rgba(255,255,255,0) 0%,
                rgba(255,255,255,0.3) 50%,
                rgba(255,255,255,0) 100%);
            background-size: 1000px 100%;
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: 200% 200%;
            animation: gradient-shift 3s ease infinite;
        }

        /* Task Card Enhancements */
        .task-card {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .task-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .task-card:hover::before {
            transform: scaleX(1);
        }

        .task-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 40px -10px rgba(31, 38, 135, 0.25);
        }

        /* Progress Bar */
        .progress-bar {
            height: 6px;
            border-radius: 999px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                rgba(255,255,255,0) 0%,
                rgba(255,255,255,0.5) 50%,
                rgba(255,255,255,0) 100%);
            animation: shimmer 2s infinite;
            background-size: 200% 100%;
        }

        /* Pulse Dot */
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Priority Badges */
        .priority-high {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .priority-medium {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .priority-low {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        }

        /* Status Badges */
        .status-done {
            background: linear-gradient(135deg, #52fa5a 0%, #21d397 100%);
        }

        .status-progress {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        /* Modal */
        .modal-backdrop {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        /* Column Headers */
        .column-header {
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* Glow Effect */
        .glow {
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3),
                        0 0 40px rgba(118, 75, 162, 0.2);
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // SSE Hook
        function useSSE(url) {
            const [data, setData] = useState(null);
            const eventSourceRef = useRef(null);

            useEffect(() => {
                eventSourceRef.current = new EventSource(url);

                eventSourceRef.current.addEventListener('task_created', (e) => {
                    setData({ type: 'created', data: JSON.parse(e.data) });
                });

                eventSourceRef.current.addEventListener('task_updated', (e) => {
                    setData({ type: 'updated', data: JSON.parse(e.data) });
                });

                eventSourceRef.current.addEventListener('file_changed', (e) => {
                    setData({ type: 'file_changed', data: JSON.parse(e.data) });
                });

                eventSourceRef.current.onerror = () => {
                    console.log('SSE connection error, reconnecting...');
                    eventSourceRef.current.close();
                    setTimeout(() => window.location.reload(), 3000);
                };

                return () => eventSourceRef.current?.close();
            }, [url]);

            return data;
        }

        // Task Card Component
        function TaskCard({ task, onUpdate }) {
            const isAI = task.source !== 'manual';
            const isInProgress = task.status === 'inProgress';
            const canEdit = !isInProgress || !isAI;

            const getPriorityClass = (pri) => {
                switch(pri) {
                    case 'H': return 'priority-high';
                    case 'M': return 'priority-medium';
                    case 'L': return 'priority-low';
                    default: return 'priority-medium';
                }
            };

            // Calculate progress (mock for demo)
            const progress = task.status === 'done' ? 100 :
                           task.status === 'inProgress' ? 65 : 0;

            return (
                <div className="task-card glass-card rounded-2xl p-5 mb-4 hover:glow">
                    <div className="flex justify-between items-start mb-3">
                        <div className="flex items-center gap-3">
                            <span className="font-mono text-sm font-bold gradient-text">
                                {task.id}
                            </span>
                            <span className="text-2xl floating">
                                {isAI ? 'ü§ñ' : 'üë§'}
                            </span>
                        </div>
                        {task.pri && (
                            <span className={`${getPriorityClass(task.pri)} px-3 py-1 rounded-full text-xs font-bold text-white shadow-lg`}>
                                {task.pri === 'H' ? 'High' : task.pri === 'M' ? 'Medium' : 'Low'}
                            </span>
                        )}
                    </div>

                    <h3 className="font-bold text-gray-900 mb-3 text-lg">
                        {task.title}
                    </h3>

                    {task.ac && (
                        <div className="text-sm text-gray-700 mb-3 space-y-1">
                            {task.ac.split('|').map((criterion, idx) => (
                                <div key={idx} className="flex items-start gap-2">
                                    <span className="text-purple-500 font-bold">‚Ä¢</span>
                                    <span>{criterion}</span>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Progress Bar */}
                    {progress > 0 && (
                        <div className="mt-4 mb-2">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-xs font-semibold text-gray-600">Progress</span>
                                <span className="text-xs font-bold gradient-text">{progress}%</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                <div
                                    className="progress-bar h-full transition-all duration-500"
                                    style={{ width: `${progress}%` }}
                                />
                            </div>
                        </div>
                    )}

                    {/* Status Badges */}
                    {isInProgress && (
                        <div className="mt-4 flex items-center gap-2 status-progress px-3 py-2 rounded-xl">
                            <span className="pulse-dot text-white">‚öôÔ∏è</span>
                            <span className="font-bold text-white text-sm">AI is working on this...</span>
                        </div>
                    )}

                    {task.status === 'done' && (
                        <div className="mt-4 flex items-center gap-2 status-done px-3 py-2 rounded-xl">
                            <span className="text-white font-bold">‚úì</span>
                            <span className="font-bold text-white text-sm">Completed</span>
                        </div>
                    )}
                </div>
            );
        }

        // Kanban Board Component
        function KanbanBoard({ tasks }) {
            const columns = {
                backlog: { title: 'üìã Backlog', icon: 'üìã', gradient: 'from-purple-500 to-pink-500' },
                inProgress: { title: '‚ö° In Progress', icon: '‚ö°', gradient: 'from-blue-500 to-cyan-500' },
                done: { title: '‚úÖ Done', icon: '‚úÖ', gradient: 'from-green-500 to-emerald-500' }
            };

            const getTaskCount = (column) => {
                return tasks[column]?.length || 0;
            };

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {Object.entries(columns).map(([key, { title, icon, gradient }]) => (
                        <div key={key} className="flex flex-col">
                            {/* Column Header */}
                            <div className={`column-header rounded-2xl p-4 mb-4 border border-white/30`}>
                                <div className="flex items-center justify-between">
                                    <h2 className="text-lg font-bold text-white flex items-center gap-2">
                                        <span className="text-2xl">{icon}</span>
                                        <span>{title.replace(/[üìã‚ö°‚úÖ]\s/, '')}</span>
                                    </h2>
                                    <span className="glass px-3 py-1 rounded-full text-sm font-bold text-white">
                                        {getTaskCount(key)}
                                    </span>
                                </div>
                            </div>

                            {/* Column Content */}
                            <div className="glass rounded-2xl p-4 min-h-[500px] border border-white/20">
                                {tasks[key]?.map(task => (
                                    <TaskCard key={task.id} task={task} />
                                ))}

                                {/* Empty State */}
                                {getTaskCount(key) === 0 && (
                                    <div className="text-center text-white/60 mt-12">
                                        <p className="text-6xl mb-4 opacity-20">{icon}</p>
                                        <p className="text-sm font-semibold">No tasks yet</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        // Add Task Modal
        function AddTaskModal({ isOpen, onClose, onAdd }) {
            const [title, setTitle] = useState('');
            const [description, setDescription] = useState('');
            const [priority, setPriority] = useState('M');

            const handleSubmit = (e) => {
                e.preventDefault();
                onAdd({ title, description, pri: priority });
                setTitle('');
                setDescription('');
                setPriority('M');
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/40 modal-backdrop flex items-center justify-center z-50 p-4">
                    <div className="glass-card rounded-3xl shadow-2xl max-w-md w-full p-8 border-2 border-white/30 glow">
                        <h2 className="text-2xl font-bold mb-6 gradient-text">‚ú® Add New Task</h2>

                        <form onSubmit={handleSubmit}>
                            <div className="mb-5">
                                <label className="block text-sm font-bold text-gray-700 mb-2">
                                    Task Title
                                </label>
                                <input
                                    type="text"
                                    value={title}
                                    onChange={(e) => setTitle(e.target.value)}
                                    className="w-full px-4 py-3 border-2 border-purple-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all font-medium"
                                    placeholder="Enter task title..."
                                    required
                                    autoFocus
                                />
                            </div>

                            <div className="mb-5">
                                <label className="block text-sm font-bold text-gray-700 mb-2">
                                    Description (optional)
                                </label>
                                <textarea
                                    value={description}
                                    onChange={(e) => setDescription(e.target.value)}
                                    className="w-full px-4 py-3 border-2 border-purple-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all font-medium"
                                    rows="3"
                                    placeholder="Add task details..."
                                />
                            </div>

                            <div className="mb-6">
                                <label className="block text-sm font-bold text-gray-700 mb-2">
                                    Priority
                                </label>
                                <select
                                    value={priority}
                                    onChange={(e) => setPriority(e.target.value)}
                                    className="w-full px-4 py-3 border-2 border-purple-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all font-bold"
                                >
                                    <option value="H">üî• High</option>
                                    <option value="M">‚ö° Medium</option>
                                    <option value="L">üíö Low</option>
                                </select>
                            </div>

                            <div className="flex gap-3">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 px-6 py-3 glass border-2 border-white/30 rounded-xl hover:bg-white/20 transition-all font-bold text-gray-700"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    className="flex-1 px-6 py-3 gradient-bg text-white rounded-xl hover:scale-105 transition-all font-bold shadow-lg"
                                >
                                    Add Task
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Main App
        function App() {
            const [tasks, setTasks] = useState({ backlog: [], inProgress: [], done: [] });
            const [loading, setLoading] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [agentStatus, setAgentStatus] = useState('idle');

            const sseUpdate = useSSE('/stream');

            // Initial load
            useEffect(() => {
                fetch('/api/tasks')
                    .then(res => res.json())
                    .then(data => {
                        setTasks(data);
                        setLoading(false);
                    })
                    .catch(err => console.error('Error loading tasks:', err));
            }, []);

            // Handle SSE updates
            useEffect(() => {
                if (sseUpdate?.type === 'file_changed') {
                    setTasks(sseUpdate.data);

                    // Check agent status
                    const inProgress = sseUpdate.data.inProgress || [];
                    setAgentStatus(inProgress.length > 0 ? 'working' : 'idle');
                }
            }, [sseUpdate]);

            const handleAddTask = async (taskData) => {
                try {
                    const response = await fetch('/api/tasks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(taskData)
                    });

                    if (response.ok) {
                        // Task added, will be updated via SSE
                    }
                } catch (err) {
                    console.error('Error adding task:', err);
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="spinner floating mx-auto mb-6"></div>
                            <p className="text-white text-lg font-bold">Loading tasks...</p>
                            <p className="text-white/60 text-sm mt-2">Preparing your workspace</p>
                        </div>
                    </div>
                );
            }

            const totalTasks = (tasks.backlog?.length || 0) +
                              (tasks.inProgress?.length || 0) +
                              (tasks.done?.length || 0);

            const completionRate = totalTasks > 0
                ? Math.round((tasks.done?.length || 0) / totalTasks * 100)
                : 0;

            return (
                <div className="min-h-screen">
                    {/* Header */}
                    <header className="glass border-b border-white/20 sticky top-0 z-40 backdrop-blur-xl">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-4xl font-black text-white mb-2 flex items-center gap-3">
                                        <span className="text-5xl">üöÄ</span>
                                        <span className="gradient-text" style={{
                                            background: 'linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%)',
                                            WebkitBackgroundClip: 'text',
                                            WebkitTextFillColor: 'transparent'
                                        }}>
                                            Task Board
                                        </span>
                                    </h1>
                                    <div className="flex items-center gap-4 text-sm text-white/80">
                                        <span className="font-semibold">
                                            üìä {totalTasks} total tasks
                                        </span>
                                        <span className="font-semibold">
                                            ‚úÖ {completionRate}% complete
                                        </span>
                                    </div>
                                </div>

                                <div className="flex items-center gap-4">
                                    {/* Agent Status */}
                                    <div className="glass px-4 py-2 rounded-xl border border-white/30 flex items-center gap-3">
                                        <span className={`inline-block w-3 h-3 rounded-full ${
                                            agentStatus === 'working'
                                                ? 'bg-green-400 pulse-dot shadow-lg'
                                                : 'bg-gray-400'
                                        }`}></span>
                                        <span className="text-sm text-white font-bold">
                                            Agent: {agentStatus === 'working' ? '‚ö° Working' : 'üí§ Idle'}
                                        </span>
                                    </div>

                                    {/* New Task Button */}
                                    <button
                                        onClick={() => setIsModalOpen(true)}
                                        className="gradient-bg px-6 py-3 text-white rounded-xl hover:scale-105 transition-all flex items-center gap-2 font-bold shadow-lg glow"
                                    >
                                        <span className="text-2xl">+</span>
                                        <span>New Task</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <KanbanBoard tasks={tasks} />
                    </main>

                    {/* Add Task Modal */}
                    <AddTaskModal
                        isOpen={isModalOpen}
                        onClose={() => setIsModalOpen(false)}
                        onAdd={handleAddTask}
                    />
                </div>
            );
        }

        // Render
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
